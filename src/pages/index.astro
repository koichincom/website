---
import { getCollection } from "astro:content";
import BaseLayout from "../layouts/BaseLayout.astro";

import PageTitle from "../components/PageTitle.astro";
import SectionTitle from "../components/SectionTitle.astro";
import WritingList from "../components/WritingList.astro";
import ProjectList from "../components/ProjectList.astro";
import CopyStr from "../components/CopyStr.astro";
import NewWindowLink from "../components/NewWindowLink.astro";

const title = "Koichi Nakayamada";
const h1Title = "Build Things, Analyze Data";

// Fetch projects sorted by pinned and published date, take featured ones
const projects = (await getCollection("projects"))
    .filter((project) => project.data.featured)
    .sort((a, b) => {
        const pinnedDelta =
            Number(b.data.pinned ?? false) - Number(a.data.pinned ?? false);
        if (pinnedDelta !== 0) return pinnedDelta;
        return (
            new Date(b.data.published).getTime() -
            new Date(a.data.published).getTime()
        );
    });

const writingPosts = (await getCollection("writing"))
    .sort(
        (a, b) =>
            new Date(b.data.published).getTime() -
            new Date(a.data.published).getTime(),
    )
    .slice(0, 3);
---

<BaseLayout metaTitle={title}>
    <PageTitle>{h1Title}</PageTitle>
    <div class="flex flex-col gap-8 sm:gap-12 pb-4">
        <section>
            <p
                class="px-content-inset text-base text-(--color-text-second) dark:text-(--color-text-second-dark) leading-relaxed"
            >
                A Japanese developer and Data Science student, studying in the
                U.S. <br />Lately I work on <NewWindowLink
                    href="https://github.com/koichincom/count.nvim"
                    >count.nvim</NewWindowLink
                >, a Neovim plugin for counting various text file metrics for
                writing.<br /> You can follow me either by <a href="feed"
                    >Atom feed</a
                > or
                <NewWindowLink href="https://x.com/koichincom"
                    >X (Twitter)</NewWindowLink
                > and get in contact with me using <NewWindowLink
                    href="https://example.com">Signal</NewWindowLink
                > or <CopyStr copyValue="k@koichin.com">Email</CopyStr>.
            </p>
        </section>

        <section>
            <video controls preload="none" playsinline>
                <source src="/test.mp4" type="video/mp4" />
            </video>
        </section>

        <section>
            <SectionTitle>Featured Projects</SectionTitle>
            <ProjectList projects={projects} />
        </section>

        <section>
            <SectionTitle>Latest Writing</SectionTitle>
            <WritingList posts={writingPosts} />
        </section>
    </div>

    <script>
        import { AGE } from "../scripts/age-calculator";
        const ageDisplay = document.getElementById("age-display");
        if (ageDisplay) {
            ageDisplay.textContent = AGE.toString();
        }
    </script>
</BaseLayout>
