---
import Logo from "./Logo.astro";
import {
    getActiveSection,
    getExactActiveSection,
    normalizePath,
    type TopLevelPath,
} from "../utils/nav-section";

interface NavItem {
    path: TopLevelPath;
    href: string;
    label: string;
}

const navItems: NavItem[] = [
    { path: "writing", href: "/writing", label: "Writing" },
    { path: "project", href: "/project", label: "Projects" },
    { path: "about", href: "/about", label: "About" },
];

const normalizedPath = normalizePath(Astro.url.pathname);
const activeExactSection = getExactActiveSection(normalizedPath);
const activeSection = getActiveSection(normalizedPath);

const NAV_ITEM_HITBOX_BASE =
    "nav-item group inline-flex items-center";
const NAV_ITEM_PILL_BASE =
    "nav-pill inline-flex items-center rounded-full px-surface-inset py-1";
const NAV_ITEM_HOME_PILL_GAP = "gap-2 sm:gap-3";
const NAV_ITEM_PILL_HOVER_BG =
    "group-hover:bg-(--color-hover) dark:group-hover:bg-(--color-hover-dark)";
const NAV_ITEM_PILL_HOVER_TEXT =
    "group-hover:text-(--color-accent-light) dark:group-hover:text-(--color-accent-dark)";
const NAV_ITEM_PILL_ACTIVE_VARIANTS =
    "group-data-[active=section]:bg-(--color-hover) dark:group-data-[active=section]:bg-(--color-hover-dark) group-data-[active=section]:text-(--color-accent-light) dark:group-data-[active=section]:text-(--color-accent-dark)";
const NAV_ITEM_PILL_PENDING_VARIANTS =
    "group-data-[pending=true]:bg-(--color-hover) dark:group-data-[pending=true]:bg-(--color-hover-dark) group-data-[pending=true]:text-(--color-accent-light) dark:group-data-[pending=true]:text-(--color-accent-dark)";
const NAV_CONTAINER_HAS_ACTIVE_SUPPRESS =
    "[&:has(.nav-home:hover)_.nav-item[data-active]:not(:hover)_>.nav-pill]:bg-transparent dark:[&:has(.nav-home:hover)_.nav-item[data-active]:not(:hover)_>.nav-pill]:bg-transparent [&:has(.nav-right:hover)_.nav-item[data-active]:not(:hover)_>.nav-pill]:bg-transparent dark:[&:has(.nav-right:hover)_.nav-item[data-active]:not(:hover)_>.nav-pill]:bg-transparent";
const NAV_CONTAINER_HAS_ACTIVE_TEXT_SUPPRESS =
    "[&:has(.nav-home:hover)_.nav-item[data-active]:not(:hover)_>.nav-pill]:!text-(--color-text-second) dark:[&:has(.nav-home:hover)_.nav-item[data-active]:not(:hover)_>.nav-pill]:!text-(--color-text-second-dark) [&:has(.nav-right:hover)_.nav-item[data-active]:not(:hover)_>.nav-pill]:!text-(--color-text-second) dark:[&:has(.nav-right:hover)_.nav-item[data-active]:not(:hover)_>.nav-pill]:!text-(--color-text-second-dark)";
const NAV_CONTAINER_PENDING_SUPPRESS =
    "[&[data-nav-pending='true']_.nav-item[data-active]:not(:hover)_>.nav-pill]:bg-transparent dark:[&[data-nav-pending='true']_.nav-item[data-active]:not(:hover)_>.nav-pill]:bg-transparent";
const NAV_CONTAINER_PENDING_TEXT_SUPPRESS =
    "[&[data-nav-pending='true']_.nav-item[data-active]:not(:hover)_>.nav-pill]:!text-(--color-text-second) dark:[&[data-nav-pending='true']_.nav-item[data-active]:not(:hover)_>.nav-pill]:!text-(--color-text-second-dark)";
const navClass = [
    "h-full max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 flex items-center justify-between text-base text-(--color-text-second) dark:text-(--color-text-second-dark) whitespace-nowrap",
    NAV_CONTAINER_HAS_ACTIVE_SUPPRESS,
    NAV_CONTAINER_HAS_ACTIVE_TEXT_SUPPRESS,
    NAV_CONTAINER_PENDING_SUPPRESS,
    NAV_CONTAINER_PENDING_TEXT_SUPPRESS,
]
    .filter(Boolean)
    .join(" ");
const homeLinkClass = [NAV_ITEM_HITBOX_BASE].filter(Boolean).join(" ");
const homePillClass = [
    NAV_ITEM_PILL_BASE,
    NAV_ITEM_HOME_PILL_GAP,
    NAV_ITEM_PILL_HOVER_BG,
    NAV_ITEM_PILL_HOVER_TEXT,
    NAV_ITEM_PILL_ACTIVE_VARIANTS,
    NAV_ITEM_PILL_PENDING_VARIANTS,
]
    .filter(Boolean)
    .join(" ");
const navItemLinkClass = [NAV_ITEM_HITBOX_BASE].join(" ");
const navItemPillClass = [
    NAV_ITEM_PILL_BASE,
    NAV_ITEM_PILL_HOVER_BG,
    NAV_ITEM_PILL_HOVER_TEXT,
    NAV_ITEM_PILL_ACTIVE_VARIANTS,
    NAV_ITEM_PILL_PENDING_VARIANTS,
]
    .filter(Boolean)
    .join(" ");
---

<header
    class="sticky top-0 z-50 h-18 sm:h-22 bg-(--color-background) dark:bg-(--color-background-dark)"
>
    <nav class={navClass} data-site-nav>
        <div class="flex nav-home">
            {
                activeExactSection === "home" ? (
                    <span
                        class={homeLinkClass}
                        data-section="home"
                        data-href="/"
                        data-active="section"
                        aria-current="page"
                    >
                        <span class={homePillClass}>
                            <Logo class="h-4 w-auto" />
                            <span class="text-base sm:text-lg">
                                Koichi Nakayamada
                            </span>
                        </span>
                    </span>
                ) : (
                    <a
                        href="/"
                        class={homeLinkClass}
                        data-section="home"
                        data-href="/"
                    >
                        <span class={homePillClass}>
                            <Logo class="h-4 w-auto" />
                            <span class="text-base sm:text-lg">
                                Koichi Nakayamada
                            </span>
                        </span>
                    </a>
                )
            }
        </div>

        <div class="flex gap-2 sm:gap-3 nav-right">
            {
                navItems.map((item) =>
                    activeSection === item.path ? (
                        activeExactSection === item.path ? (
                            <span
                                class={navItemLinkClass}
                                data-section={item.path}
                                data-href={item.href}
                                data-active="section"
                                aria-current="page"
                            >
                                <span class={navItemPillClass}>
                                    {item.label}
                                </span>
                            </span>
                        ) : (
                            <a
                                href={item.href}
                                class={navItemLinkClass}
                                data-section={item.path}
                                data-href={item.href}
                                data-active="section"
                            >
                                <span class={navItemPillClass}>
                                    {item.label}
                                </span>
                            </a>
                        )
                    ) : (
                        <a
                            href={item.href}
                            class={navItemLinkClass}
                            data-section={item.path}
                            data-href={item.href}
                        >
                            <span class={navItemPillClass}>{item.label}</span>
                        </a>
                    ),
                )
            }
        </div>
    </nav>
</header>
