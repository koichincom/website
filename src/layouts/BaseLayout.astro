---
import "../styles/global.css";
import { Font } from "astro:assets";
import { ClientRouter } from "astro:transitions";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";

export interface Props {
    metaTitle: string;
    description?: string;
}
type FeedScope = "combined" | "project" | "writing";

const { metaTitle = "Koichi Nakayamada", description } = Astro.props;

const siteUrl = "https://koichin.com" + Astro.url.pathname;
const pathToAbsoluteUrl = (path: string): string => {
    return Astro.site ? new URL(path, Astro.site).toString() : path;
};

const feedPathMap: Record<
    FeedScope,
    { label: string; atom: string; rss: string }
> = {
    combined: {
        label: "Combined",
        atom: "/atom/",
        rss: "/rss/",
    },
    writing: {
        label: "Writing",
        atom: "/atom/writing/",
        rss: "/rss/writing/",
    },
    project: {
        label: "Project",
        atom: "/atom/project/",
        rss: "/rss/project/",
    },
};

const feedScopeOrder: FeedScope[] = Astro.url.pathname.startsWith("/project")
    ? ["combined", "project", "writing"]
    : ["combined", "writing", "project"];

const feedAlternates = feedScopeOrder.flatMap((scope) => {
    const feedPaths = feedPathMap[scope];

    return [
        {
            type: "application/atom+xml",
            title: `Koichi Nakayamada ${feedPaths.label} Atom`,
            href: pathToAbsoluteUrl(feedPaths.atom),
        },
        {
            type: "application/rss+xml",
            title: `Koichi Nakayamada ${feedPaths.label} RSS`,
            href: pathToAbsoluteUrl(feedPaths.rss),
        },
    ];
});

// Container class for width constraints
const containerClass = "max-w-5xl w-full mx-auto px-4 sm:px-6 lg:px-8";
---

<html
    lang="en"
    class="bg-(--color-background) dark:bg-(--color-background-dark)"
    transition:animate="none"
>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width" />
        <meta name="generator" content={Astro.generator} />
        <meta name="description" content={description} />
        <title>{metaTitle}</title>
        <ClientRouter />

        <style>
            html,
            body {
                background: #f1f1f1;
                color-scheme: light dark;
            }

            @media (prefers-color-scheme: dark) {
                html,
                body {
                    background: #111111;
                }
            }
        </style>

        <meta property="og:title" content={metaTitle} />
        <meta property="og:description" content={description} />
        <meta property="og:url" content={siteUrl} />
        <meta property="og:type" content="website" />

        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:title" content={metaTitle} />
        <meta name="twitter:description" content={description} />
        <meta name="twitter:creator" content="@koichincom" />

        <meta name="theme-color" content="#f1f1f1" />
        <meta
            name="theme-color"
            content="#111111"
            media="(prefers-color-scheme: dark)"
        />

        <link rel="canonical" href={siteUrl} />
        <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg" />

        {
            feedAlternates.map((feed) => (
                <link
                    rel="alternate"
                    type={feed.type}
                    title={feed.title}
                    href={feed.href}
                />
            ))
        }

        <Font cssVariable="--font-iosevka-aile" preload />
    </head>
    <body
        class="bg-(--color-background) dark:bg-(--color-background-dark) text-(--color-text-first) dark:text-(--color-text-first-dark) text-base flex flex-col min-h-screen gap-8"
    >
        <a
            href="#main-content"
            class="sr-only focus:not-sr-only focus:fixed focus:top-4 focus:left-4 focus:z-[60] focus:bg-(--color-background) dark:focus:bg-(--color-background-dark) focus:text-(--color-text-first) dark:focus:text-(--color-text-first-dark) focus:px-4 focus:py-2 focus:rounded focus:shadow"
        >
            Skip to content
        </a>

        <Header />

        <main id="main-content" class:list={[containerClass, "flex-1"]}>
            <slot />
        </main>

        <div class={containerClass}>
            <Footer />
        </div>

        <script is:inline>
            const normalizePath = (path) => {
                if (path === "/") return "/";
                return path.replace(/\/$/, "");
            };

            const getExactActiveSection = (path) => {
                if (path === "/") return "home";
                if (path === "/writing") return "writing";
                if (path === "/project") return "project";
                if (path === "/about") return "about";
                return null;
            };

            const getActiveSection = (path) => {
                if (path === "/") return "home";
                if (path.startsWith("/writing")) return "writing";
                if (path.startsWith("/project")) return "project";
                if (path.startsWith("/about")) return "about";
                return null;
            };

            const updateNavState = () => {
                const nav = document.querySelector("[data-site-nav]");
                if (!nav) return;

                const normalizedPath = normalizePath(window.location.pathname);
                const activeExactSection =
                    getExactActiveSection(normalizedPath);
                const activeSection = getActiveSection(normalizedPath);

                nav.setAttribute(
                    "data-home-exact",
                    activeExactSection === "home" ? "true" : "false"
                );

                const items = nav.querySelectorAll("[data-section]");

                items.forEach((item) => {
                    const section = item.dataset.section;
                    if (!section) return;

                    const isHome = section === "home";
                    const isActiveExactHome =
                        isHome && activeExactSection === "home";
                    const isActiveSection =
                        !isHome && section === activeSection;

                    if (isActiveExactHome || isActiveSection) {
                        item.setAttribute("aria-current", "page");
                    } else {
                        item.removeAttribute("aria-current");
                    }

                    if (isHome) {
                        if (isActiveExactHome) {
                            item.removeAttribute("href");
                        } else {
                            const href = item.getAttribute("data-href");
                            if (href) item.setAttribute("href", href);
                        }
                        item.removeAttribute("data-active");
                        return;
                    }

                    if (isActiveSection) {
                        item.setAttribute("data-active", "section");
                        item.removeAttribute("href");
                        return;
                    }

                    item.removeAttribute("data-active");
                    const href = item.getAttribute("data-href");
                    if (href) item.setAttribute("href", href);
                });
            };

            const setNavPending = (pending) => {
                const nav = document.querySelector("[data-site-nav]");
                if (!nav) return;
                if (pending) {
                    nav.setAttribute("data-nav-pending", "true");
                } else {
                    nav.removeAttribute("data-nav-pending");
                }
            };

            updateNavState();
            setNavPending(false);
            document.addEventListener("astro:before-preparation", () => {
                setNavPending(true);
            });
            document.addEventListener("astro:after-swap", () => {
                updateNavState();
                setNavPending(false);
            });
        </script>
    </body>
</html>
