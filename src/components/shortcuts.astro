---
interface Props {
    id: string;
}
const { id } = Astro.props;
---

<dialog
  id={id}
  tabindex="-1"
  aria-modal="true"
  aria-labelledby={`${id}-title`}
  class="rounded-lg bg-(--color-background) dark:bg-(--color-background-dark) p-6 max-w-2xl w-full backdrop:bg-black backdrop:opacity-30 dark:backdrop:opacity-80 fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 outline-none shadow-xl"
>
    <div class="relative font-sans">
        <div class="flex justify-between items-center mb-6">
            <h2 id={`${id}-title`} class="text-lg font-medium text-(--color-text-first) dark:text-(--color-text-first-dark)">
                Shortcuts
            </h2>
            <button
                id={`${id}-close-button`}
                class="text-(--color-text-third) dark:text-(--color-text-third-dark) hover:text-(--color-text-first) dark:hover:text-(--color-text-first-dark) text-xs"
                aria-label="Close"
            >
                Esc to Close
            </button>
        </div>

        <div class="grid grid-cols-2 gap-x-12 text-sm text-(--color-text-second) dark:text-(--color-text-second-dark)">
            <div class="grid grid-cols-[2rem_1fr] gap-y-2 items-baseline">
                <span class="font-medium text-(--color-text-first) dark:text-(--color-text-first-dark)">h</span>
                <span>Home</span>
                <span class="font-medium text-(--color-text-first) dark:text-(--color-text-first-dark)">w</span>
                <span>Writing</span>
                <span class="font-medium text-(--color-text-first) dark:text-(--color-text-first-dark)">p</span>
                <span>Projects</span>
                <span class="font-medium text-(--color-text-first) dark:text-(--color-text-first-dark)">c</span>
                <span>Clubs</span>
                <span class="font-medium text-(--color-text-first) dark:text-(--color-text-first-dark)">y</span>
                <span>Copy Link</span>
                <span class="font-medium text-(--color-text-first) dark:text-(--color-text-first-dark)">?</span>
                <span>Shortcuts</span>
            </div>

            <div class="grid grid-cols-[2rem_1fr] gap-y-2 items-baseline">
                <span class="font-medium text-(--color-text-first) dark:text-(--color-text-first-dark)">j</span>
                <span>Scroll down</span>
                <span class="font-medium text-(--color-text-first) dark:text-(--color-text-first-dark)">k</span>
                <span>Scroll up</span>
                <span class="font-medium text-(--color-text-first) dark:text-(--color-text-first-dark)">u</span>
                <span>Scroll up half page</span>
                <span class="font-medium text-(--color-text-first) dark:text-(--color-text-first-dark)">d</span>
                <span>Scroll down half page</span>
                <span class="font-medium text-(--color-text-first) dark:text-(--color-text-first-dark)">gg</span>
                <span>Scroll to top</span>
                <span class="font-medium text-(--color-text-first) dark:text-(--color-text-first-dark)">G</span>
                <span>Scroll to bottom</span>
            </div>
        </div>
    </div>
</dialog>

<script define:vars={{ id }}>
    function initHelpModal() {
        const dialog = document.getElementById(id);
        const closeButton = document.getElementById(`${id}-close-button`);
        const helpButton = document.getElementById("help-button");

        if (!dialog || !closeButton) return;

        let focusableElements = [];

        function getFocusableElements() {
            const selector = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
            return Array.from(dialog.querySelectorAll(selector));
        }

        function trapFocus(event) {
            if (event.key !== 'Tab') return;

            focusableElements = getFocusableElements();
            if (focusableElements.length === 0) return;

            const firstElement = focusableElements[0];
            const lastElement = focusableElements[focusableElements.length - 1];

            if (event.shiftKey) {
                if (document.activeElement === firstElement) {
                    event.preventDefault();
                    lastElement.focus();
                }
            } else {
                if (document.activeElement === lastElement) {
                    event.preventDefault();
                    firstElement.focus();
                }
            }
        }

        function closeModal() {
            dialog.close();
        }

        function handleDialogOpen() {
            focusableElements = getFocusableElements();
            const firstFocusable = focusableElements[0] || closeButton;
            if (firstFocusable) firstFocusable.focus();
            dialog.addEventListener('keydown', trapFocus);
        }

        function handleDialogClose() {
            dialog.removeEventListener('keydown', trapFocus);
            if (helpButton) {
                helpButton.focus();
            }
        }

        closeButton.removeEventListener("click", closeModal);
        dialog.removeEventListener("click", handleBackdropClick);
        dialog.removeEventListener("close", handleDialogClose);
        dialog.removeEventListener("cancel", handleDialogClose);
        document.removeEventListener("keydown", handleKeydown);

        closeButton.addEventListener("click", closeModal);
        dialog.addEventListener("click", handleBackdropClick);
        dialog.addEventListener("close", handleDialogClose);
        dialog.addEventListener("cancel", handleDialogClose);
        document.addEventListener("keydown", handleKeydown);
        dialog.addEventListener('open', handleDialogOpen);

        function handleBackdropClick(event) {
            const rect = dialog.getBoundingClientRect();
            const isInDialog = (
                rect.top <= event.clientY &&
                event.clientY <= rect.top + rect.height &&
                rect.left <= event.clientX &&
                event.clientX <= rect.left + rect.width
            );

            if (!isInDialog) {
                dialog.close();
            }
        }

        function handleKeydown(event) {
            if (dialog.open && (event.key === "q" || event.key === "Escape")) {
                event.preventDefault();
                dialog.close();
            }
        }
    }

    initHelpModal();
    document.addEventListener("astro:page-load", initHelpModal);
    document.addEventListener('open-shortcuts', () => {
        const dialog = document.getElementById(id);
            if (dialog && typeof dialog.showModal === 'function') {
            dialog['showModal']();
            dialog.focus();
        }
    });
</script>
