---
interface Props {
    id: string;
}
const { id } = Astro.props;
---

<!-- Modal to show Vim help of this website -->
<dialog
  id={id}
  tabindex="-1"
  aria-modal="true"
  aria-labelledby={`${id}-title`}
  class="rounded-lg bg-(--color-background) dark:bg-(--color-background-dark) p-6 max-w-2xl w-full backdrop:bg-black backdrop:opacity-50 dark:backdrop:opacity-90 fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 outline-none"
>
    <div class="relative">
        <button
            id={`${id}-close-button`}
            class="absolute top-0 right-0 text-(--color-text-third) dark:text-(--color-text-third-dark) hover:text-(--color-text-first) dark:hover:text-(--color-text-first-dark) text-sm"
            aria-label="Close"
        >
            Esc to close
        </button>

        <h2 id={`${id}-title`} class="text-xl font-bold mb-4 text-(--color-text-first) dark:text-(--color-text-first-dark)">
            Shortcuts
        </h2>

        <div class="grid grid-cols-2 gap-8 text-base text-(--color-text-second) dark:text-(--color-text-second-dark)">
            <ul class="space-y-1">
                <li>h — Home</li>
                <li>b — Blog</li>
                <li>p — Projects</li>
                <li>v — Vision</li>
                <li>c — Club</li>
                <li>y — Copy URL</li>
            </ul>

            <ul class="space-y-1">
                <li>j — Scroll down</li>
                <li>k — Scroll up</li>
                <li>u — Scroll up half page</li>
                <li>d — Scroll down half page</li>
                <li>gg — Scroll to top</li>
                <li>G — Scroll to bottom</li>
            </ul>
        </div>
    </div>
</dialog>

<script define:vars={{ id }}>
    function initHelpModal() {
        const dialog = document.getElementById(id);
        const closeButton = document.getElementById(`${id}-close-button`);
        const helpButton = document.getElementById("help-button");

        if (!dialog || !closeButton) return;

        // Focus trap implementation
        let focusableElements = [];

        function getFocusableElements() {
            const selector = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
            return Array.from(dialog.querySelectorAll(selector));
        }

        function trapFocus(event) {
            if (event.key !== 'Tab') return;

            focusableElements = getFocusableElements();
            if (focusableElements.length === 0) return;

            const firstElement = focusableElements[0];
            const lastElement = focusableElements[focusableElements.length - 1];

            if (event.shiftKey) {
                if (document.activeElement === firstElement) {
                    event.preventDefault();
                    lastElement.focus();
                }
            } else {
                if (document.activeElement === lastElement) {
                    event.preventDefault();
                    firstElement.focus();
                }
            }
        }

        // Close button click handler
        function closeModal() {
            dialog.close();
        }

        // Handle dialog open
        function handleDialogOpen() {
            // Focus first focusable element or close button
            focusableElements = getFocusableElements();
            const firstFocusable = focusableElements[0] || closeButton;
            if (firstFocusable) firstFocusable.focus();

            // Add focus trap listener
            dialog.addEventListener('keydown', trapFocus);
        }

        // Handle dialog close
        function handleDialogClose() {
            // Remove focus trap listener
            dialog.removeEventListener('keydown', trapFocus);

            // Restore focus to help button
            if (helpButton) {
                helpButton.focus();
            }
        }

        // Remove old listeners to prevent duplicates
        closeButton.removeEventListener("click", closeModal);
        dialog.removeEventListener("click", handleBackdropClick);
        dialog.removeEventListener("close", handleDialogClose);
        dialog.removeEventListener("cancel", handleDialogClose);
        document.removeEventListener("keydown", handleKeydown);

        // Add fresh listeners
        closeButton.addEventListener("click", closeModal);
        dialog.addEventListener("click", handleBackdropClick);
        dialog.addEventListener("close", handleDialogClose);
        dialog.addEventListener("cancel", handleDialogClose);
        document.addEventListener("keydown", handleKeydown);

        // Handle dialog open events
        dialog.addEventListener('open', handleDialogOpen);

        function handleBackdropClick(event) {
            const rect = dialog.getBoundingClientRect();
            const isInDialog = (
                rect.top <= event.clientY &&
                event.clientY <= rect.top + rect.height &&
                rect.left <= event.clientX &&
                event.clientX <= rect.left + rect.width
            );

            if (!isInDialog) {
                dialog.close();
            }
        }

        // Keyboard handler for q and Esc
        function handleKeydown(event) {
            if (dialog.open && (event.key === "q" || event.key === "Escape")) {
                event.preventDefault();
                dialog.close();
            }
        }
    }

    // Initialize on page load
    initHelpModal();

    // Re-initialize after View Transitions
    document.addEventListener("astro:page-load", initHelpModal);

    // Listen for programmatic open events
    document.addEventListener('open-vim-help', () => {
        const dialog = document.getElementById(id);
            if (dialog && typeof dialog.showModal === 'function') {
            dialog['showModal']();
            dialog.focus();
        }
    });
</script>
